name: Release

on:
  release:
    types: [published]

jobs:
  build_and_push:
    name: Build & push release
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1
        with:
          install: true

      - name: QEMU
        uses: docker/setup-qemu-action@v3.6.0
        with:
          image: tonistiigi/binfmt:latest
          platforms: amd64,arm64

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Build & push release
        env:
          DOCKER_BUILDKIT: 1
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TERM: xterm-256color
          VERSION: ${{ steps.version.outputs.version }}
        run: make push

      - name: Docker Hub Description
        uses: peter-evans/dockerhub-description@v4.0.2
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
          repository: ${{ vars.DOCKER_ORG_NAME }}/${{ github.event.repository.name }}
          short-description: ${{ github.event.repository.description }}

  update_action_yml:
    name: Update action.yml with new version
    needs: build_and_push
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Update action.yml with new version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s|image: docker://devopsinfra/action-commit-push:.*|image: docker://devopsinfra/action-commit-push:${VERSION}|" action.yml
          git diff action.yml

      - name: Commit updated action.yml
        uses: ./
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit_message: "Update action.yml to use release version ${{ steps.version.outputs.version }}"
          amend: false
